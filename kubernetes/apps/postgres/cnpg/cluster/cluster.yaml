---
apiVersion: postgresql.cnpg.io/v1
kind: Cluster
metadata:
  name: &name postgres
  annotations:
    cnpg.io/skipEmptyWalArchiveCheck: enabled
spec:
  instances: 1

  certificates:
    serverTLSSecret: postgres-server-cert
    serverCASecret: postgres-server-cert
    clientCASecret: postgres-client-cert
    replicationTLSSecret: postgres-client-cert

  storage:
    size: 8Gi

  bootstrap:
    recovery:
      source: &src source

  plugins:
    - name: &plugin barman-cloud.cloudnative-pg.io
      isWALArchiver: true
      parameters:
        barmanObjectName: &store garage-store

  externalClusters:
    - name: *src
      plugin:
        name: *plugin
        parameters:
          barmanObjectName: *store
          serverName: postgres

  monitoring:
    enablePodMonitor: true

  managed:
    roles:
      - name: attic
        ensure: present
        login: true
        superuser: false
        passwordSecret:
          name: postgres-attic

      - name: autobrr
        ensure: present
        login: true
        superuser: false
        passwordSecret:
          name: postgres-autobrr

      - name: baikal
        ensure: present
        login: true
        superuser: false
        passwordSecret:
          name: postgres-baikal

      - name: bazarr
        ensure: present
        login: true
        superuser: false
        passwordSecret:
          name: postgres-bazarr

      - name: firefly
        ensure: present
        login: true
        superuser: false
        passwordSecret:
          name: postgres-firefly

      - name: forgejo
        ensure: present
        login: true
        superuser: false
        passwordSecret:
          name: postgres-forgejo
      - name: freshrss
        ensure: present
        login: true
        superuser: false
        passwordSecret:
          name: postgres-freshrss
      - name: hass
        ensure: present
        login: true
        superuser: false
        passwordSecret:
          name: postgres-home-assistant

      - name: jellyseerr
        ensure: present
        login: true
        superuser: false
        passwordSecret:
          name: postgres-jellyseerr

      - name: litellm
        ensure: present
        login: true
        superuser: false
        passwordSecret:
          name: postgres-litellm

      - name: maubot
        ensure: present
        login: true
        superuser: false
        passwordSecret:
          name: postgres-maubot

      - name: mautrix-discord
        ensure: present
        login: true
        superuser: false
        passwordSecret:
          name: postgres-mautrix-discord

      - name: mautrix-meta
        ensure: present
        login: true
        superuser: false
        passwordSecret:
          name: postgres-mautrix-meta

      - name: mealie
        ensure: present
        login: true
        superuser: false
        passwordSecret:
          name: postgres-mealie

      - name: n8n
        ensure: present
        login: true
        superuser: false
        passwordSecret:
          name: postgres-n8n

      - name: open-webui
        ensure: present
        login: true
        superuser: false
        passwordSecret:
          name: postgres-open-webui

      - name: paperless
        ensure: present
        login: true
        superuser: false
        passwordSecret:
          name: postgres-paperless

      - name: pinepods
        ensure: present
        login: true
        superuser: false
        passwordSecret:
          name: postgres-pinepods

      - name: prowlarr
        ensure: present
        login: true
        superuser: false
        passwordSecret:
          name: postgres-prowlarr

      - name: radarr
        ensure: present
        login: true
        superuser: false
        passwordSecret:
          name: postgres-radarr

      - name: rssflow
        ensure: present
        login: true
        superuser: false
        passwordSecret:
          name: postgres-rssflow

      - name: sonarr
        ensure: present
        login: true
        superuser: false
        passwordSecret:
          name: postgres-sonarr

      - name: vaultwarden
        ensure: present
        login: true
        superuser: false
        passwordSecret:
          name: postgres-vaultwarden
