---
# yaml-language-server: $schema=https://raw.githubusercontent.com/bjw-s-labs/helm-charts/main/charts/other/app-template/schemas/helmrelease-helm-v2.schema.json
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: &app ${APP}
spec:
  interval: 1h
  chartRef:
    kind: OCIRepository
    name: app-template
  install:
    remediation:
      retries: -1
  upgrade:
    cleanupOnFail: true
    remediation:
      retries: 3
  values:
    controllers:
      baikal:
        pod:
          securityContext:
            runAsUser: 101
            runAsGroup: 101
            runAsNonRoot: true
            fsGroup: 101
            fsGroupChangePolicy: OnRootMismatch

        initContainers:
          copy-config:
            image:
              repository: docker.io/busybox
              tag: 1.37.0-musl@sha256:597bf7e5e8faf26b8efc4cb558eea5dc14d9cc97d5b4c8cdbe6404a7432d5a67
              pullPolicy: IfNotPresent
            command: [ "/bin/sh", "-c", "cp /config/baikal.yaml /mnt/ && chown 101:101 /mnt/baikal.yaml" ]

        containers:
          nginx:
            image:
              repository: ckulka/baikal
              tag: 0.10.1-nginx-php8.2@sha256:0d497f25665d2e8e7b0a9c14023338ce64fc2321e254771d611472bae558652a
            env:
              - name: BAIKAL_SKIP_CHOWN
                value: "true"
          php:
            image:
              repository: ckulka/baikal
              tag: 0.10.1-nginx-php8.2@sha256:0d497f25665d2e8e7b0a9c14023338ce64fc2321e254771d611472bae558652a
            command: [ "/bin/sh", "-c", 'find /usr/sbin/ -type f -name "php-fpm*" -exec "{}" "-F" \;' ]
            # securityContext:


    service:
      app:
        controller: *app
        ports:
          http:
            port: 80
            targetPort: 8080

    route:
      app:
        hostnames: [ "{{ .Release.Name }}.${SECRET_DOMAIN}" ]
        parentRefs:
          - name: external
            namespace: envoy-gateway-system
            sectionName: https
        rules:
          - backendRefs:
              - identifier: app
                port: 80

    ingress:
      app:
        hosts:
          - host: ${APP}.${SECRET_DOMAIN}
            paths:
              - path: /
                service:
                  identifier: app
                  port: http

    persistence:
      config:
        type: secret
        name: baikal-config
        defaultMode: 0660
        advancedMounts:
          baikal:
            copy-config:
              - path: /config/baikal.yaml
                subPath: baikal.yaml
      nginx:
        type: configMap
        name: baikal-configmap
        advancedMounts:
          baikal:
            nginx:
              - path: /etc/nginx/conf.d/default.conf
                subPath: nginx.conf

      cache:
        type: emptyDir
        globalMounts:
          - path: /var/run/
            subPath: run
          - path: /var/log/
            subPath: log
        advancedMounts:
          baikal:
            nginx:
              - path: /var/cache/nginx/
                subPath: nginx
              - path: /var/log/nginx/
                subPath: log/nginx
            php:
              - path: /run/php/
                subPath: run/php
              - path: /var/www/baikal/config/
                subPath: config
            copy-config:
              - path: /mnt
                subPath: config

  #    data:
  #      size: 1Gi
  #      accessMode: ReadWriteOnce
  #      annotations:
  #        argocd.argoproj.io/sync-options: Delete=false
  #      globalMounts:
  #        - path: /var/www/baikal/Specific
