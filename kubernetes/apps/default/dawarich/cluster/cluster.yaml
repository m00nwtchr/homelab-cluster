---
apiVersion: postgresql.cnpg.io/v1
kind: Cluster
metadata:
  name: dawarich-db
  annotations:
    cnpg.io/skipEmptyWalArchiveCheck: enabled
spec:
  instances: 1
  imageName: ghcr.io/cloudnative-pg/postgis:17-3.5@sha256:2664f5525c7fa65db4a65792cc330ec24af53d3c5e3e0d4e38b81f477779c531
  storage:
    size: 4Gi

  bootstrap:
    recovery:
      owner: dawarich
      database: dawarich
      source: &src source
  #    initdb:
  #      owner: dawarich
  #      database: dawarich
  #      secret:
  #        name: postgres-dawarich

  plugins:
    - name: &plugin barman-cloud.cloudnative-pg.io
      isWALArchiver: true
      parameters:
        barmanObjectName: &store dawarich-garage-store

  externalClusters:
    - name: *src
      plugin:
        name: *plugin
        parameters:
          barmanObjectName: *store
          serverName: dawarich-db

  managed:
    roles:
      - name: dawarich
        ensure: present
        login: true
        superuser: false
        passwordSecret:
          name: postgres-dawarich
---
apiVersion: postgresql.cnpg.io/v1
kind: Database
metadata:
  name: dawarich
spec:
  name: dawarich
  owner: dawarich
  cluster:
    name: dawarich-db
  extensions:
    - name: postgis
    - name: postgis_topology
    - name: fuzzystrmatch
    - name: postgis_tiger_geocoder
