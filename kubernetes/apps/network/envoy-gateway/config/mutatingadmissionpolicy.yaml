---
# yaml-language-server: $schema=https://raw.githubusercontent.com/yannh/kubernetes-json-schema/refs/heads/master/v1.32.0/mutatingadmissionpolicybinding-admissionregistration-v1beta1.json
apiVersion: admissionregistration.k8s.io/v1alpha1
kind: MutatingAdmissionPolicyBinding
metadata:
  name: envoy-gateway-priorityclass
spec:
  policyName: envoy-gateway-priorityclass
---
# yaml-language-server: $schema=https://raw.githubusercontent.com/yannh/kubernetes-json-schema/refs/heads/master/v1.32.0/mutatingadmissionpolicy-admissionregistration-v1beta1.json
apiVersion: admissionregistration.k8s.io/v1alpha1
kind: MutatingAdmissionPolicy
metadata:
  name: envoy-gateway-priorityclass
spec:
  matchConstraints:
    resourceRules:
      - apiGroups:
          - batch
        apiVersions:
          - apps/v1
        operations:
          - CREATE
          - UPDATE
        resources:
          - deployments
  matchConditions:
    - name: has-proxy-component-labels
      expression: >-
        object.metadata.labels["app.kubernetes.io/component"] == "proxy"

    - name: has-envoy-managed-by-labels
      expression: >-
        object.metadata.labels["app.kubernetes.io/managed-by"] == "envoy-gateway"
  failurePolicy: Fail
  reinvocationPolicy: IfNeeded
  mutations:
    - patchType: JSONPatch
      jsonPatch:
        expression: >-
          [
            JSONPatch{
              op: "set", path: "/spec/template/spec/priorityClassName",
              value: "system-cluster-critical"
            }
          ]
