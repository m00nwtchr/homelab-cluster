---
# yaml-language-server: $schema=https://raw.githubusercontent.com/bjw-s-labs/helm-charts/main/charts/other/app-template/schemas/helmrelease-helm-v2.schema.json
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: &app ${APP}
spec:
  interval: 1h
  chartRef:
    kind: OCIRepository
    name: app-template
  install:
    remediation:
      retries: -1
  upgrade:
    cleanupOnFail: true
    remediation:
      retries: 3
  values:
    controllers:
      *app :
        containers:
          app:
            image:
              repository: ghcr.io/m00nwtchr/rssflow
              tag: master@sha256:91bfb28138cf738ae284b672855cd627010a74f7bc984a4768e5d31202e0c050
            env:
              RUST_LOG: "info"
              REDIS_URL: redis://dragonfly.database.svc/10
            envFrom:
              - secretRef:
                  name: rssflow-env
            probes: &probes
              liveness: &probe
                enabled: true
                custom: true
                spec:
                  grpc:
                    port: &port 50051
                  #                  service: ""
                  initialDelaySeconds: 5
                  periodSeconds: 10
              readiness: *probe
            resources:
              requests:
                cpu: 50m
                memory: 256Mi

      websub:
        containers:
          app: &container
            image:
              repository: ghcr.io/m00nwtchr/rssflow-websub
              tag: master@sha256:42d7c8536fd0855eff90adbe9a23042d1575f9970932f2d4cadb045086cf1e1a
            env: &svc-env
              RUST_LOG: "info"
              REDIS_URL: redis://dragonfly.database.svc/10
            envFrom:
              - secretRef:
                  name: rssflow-websub-env
            probes: *probes
            resources:
              requests:
                cpu: 50m
                memory: 256Mi

      fetch:
        pod: &node-pod
          labels:
            app.kubernetes.io/component: node
        containers:
          app:
            <<: *container
            image:
              repository: ghcr.io/m00nwtchr/rssflow-fetch
              tag: master@sha256:9d2d67750d9343780a8232c96f03963cc53d0fbc9ed7372ee097d547fb1f92f2
            env:
              <<: *svc-env
              SERVICE_URL: http://rssflow-fetch:50051/

      filter:
        pod: *node-pod
        containers:
          app:
            <<: *container
            image:
              repository: ghcr.io/m00nwtchr/rssflow-filter
              tag: master@sha256:931d4544b3920d284cc1f8d7b2f0c5026e13af483317468018093d4c49b571e6
            env:
              <<: *svc-env
              SERVICE_URL: http://rssflow-filter:50051/

      replace:
        pod: *node-pod
        containers:
          app:
            <<: *container
            image:
              repository: ghcr.io/m00nwtchr/rssflow-replace
              tag: master@sha256:0437ea16a6fff2f484c25a36845f9e53693ddce04da31263cd04a16dc0ebf192
            env:
              <<: *svc-env
              SERVICE_URL: http://rssflow-replace:50051/

      retrieve:
        pod: *node-pod
        containers:
          app:
            <<: *container
            image:
              repository: ghcr.io/m00nwtchr/rssflow-retrieve
              tag: master@sha256:746a6ff4dfb656fe14efc8b2c60f1c6df6e633abbf29592c32f98ddae0b2e332
            env:
              <<: *svc-env
              SERVICE_URL: http://rssflow-retrieve:50051/

      sanitize:
        pod: *node-pod
        containers:
          app:
            <<: *container
            image:
              repository: ghcr.io/m00nwtchr/rssflow-sanitize
              tag: master@sha256:df95de8adb03f130b9f8cf345fdd70441c91245e4fc5afbc10a4b674cb0649d8
            env:
              <<: *svc-env
              SERVICE_URL: http://rssflow-sanitize:50051/

    #    rbac:
    #      roles:
    #        rssflow:
    #          type: ClusterRole
    #          rules:
    #            - apiGroups:
    #                - ""
    #              resources:
    #                - services
    #              verbs:
    #                - get
    #                - list
    #                - watch
    #            - apiGroups:
    #                - discovery.k8s.io
    #              resources:
    #                - endpointslices
    #              verbs:
    #                - get
    #                - list
    #                - watch
    #
    #      bindings:
    #        rssflow:
    #          type: ClusterRoleBinding
    #          roleRef:
    #            identifier: rssflow
    #          subjects:
    #            - identifier: rssflow
    #
    #    serviceAccount:
    #      rssflow: { }

    service:
      rssflow:
        controller: rssflow
        ports:
          http:
            port: 80
            targetPort: 3434
          grpc:
            port: *port

      websub:
        controller: websub
        ports:
          http:
            port: 80
            targetPort: 3435
          grpc:
            port: *port

      fetch: &svc
        controller: fetch
        publishNotReadyAddresses: true
        ports:
          grpc:
            port: *port

      filter:
        <<: *svc
        controller: filter

      replace:
        <<: *svc
        controller: replace

      retrieve:
        <<: *svc
        controller: retrieve

      sanitize:
        <<: *svc
        controller: sanitize

    route:
      websub:
        hostnames:
          - "{{ .Release.Name }}.${SECRET_DOMAIN}"
        parentRefs:
          - name: external
            namespace: envoy-gateway-system
            sectionName: https
        rules:
          - matches:
              - path:
                  type: PathPrefix
                  value: /websub/
            backendRefs:
              - identifier: websub
                port: 80
