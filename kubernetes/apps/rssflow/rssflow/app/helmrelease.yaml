---
# yaml-language-server: $schema=https://raw.githubusercontent.com/bjw-s-labs/helm-charts/main/charts/other/app-template/schemas/helmrelease-helm-v2.schema.json
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: &app ${APP}
spec:
  interval: 1h
  chartRef:
    kind: OCIRepository
    name: app-template
  install:
    remediation:
      retries: -1
  upgrade:
    cleanupOnFail: true
    remediation:
      retries: 3
  values:
    controllers:
      *app :
        containers:
          app:
            image:
              repository: ghcr.io/m00nwtchr/rssflow
              tag: master@sha256:0434255be077cf187a40d1b7db26f7782fe7239f4f0a117f1a4256880222308f
            env:
              RUST_LOG: "info"
              REDIS_URL: redis://dragonfly.database.svc/10
            envFrom:
              - secretRef:
                  name: rssflow-env
            probes: &probes
              liveness: &probe
                enabled: true
                custom: true
                spec:
                  grpc:
                    port: &port 50051
                  #                  service: ""
                  initialDelaySeconds: 5
                  periodSeconds: 10
              readiness: *probe
            resources:
              requests:
                cpu: 50m
                memory: 256Mi

      websub:
        containers:
          app: &container
            image:
              repository: ghcr.io/m00nwtchr/rssflow-websub
              tag: master@sha256:ca88291850c63943db05b43cbe107c32bfc950477b8834d41cbe2fec460d7fdc
            env: &svc-env
              RUST_LOG: "info"
              REDIS_URL: redis://dragonfly.database.svc/10
            envFrom:
              - secretRef:
                  name: rssflow-websub-env
            probes: *probes
            resources:
              requests:
                cpu: 50m
                memory: 256Mi

      fetch:
        pod: &node-pod
          labels:
            app.kubernetes.io/component: node
        containers:
          app:
            <<: *container
            image:
              repository: ghcr.io/m00nwtchr/rssflow-fetch
              tag: master@sha256:e3bd3889b2b8f5ce26519219a0223a54d4da25ee74c3e51cc282a15a4bb423fc
            env:
              <<: *svc-env
              SERVICE_URL: http://rssflow-fetch:50051/

      filter:
        pod: *node-pod
        containers:
          app:
            <<: *container
            image:
              repository: ghcr.io/m00nwtchr/rssflow-filter
              tag: master@sha256:12fb8b41987ae754008f10e91f668eb6e86710308390ed04b6c3af34180e60c3
            env:
              <<: *svc-env
              SERVICE_URL: http://rssflow-filter:50051/

      replace:
        pod: *node-pod
        containers:
          app:
            <<: *container
            image:
              repository: ghcr.io/m00nwtchr/rssflow-replace
              tag: master@sha256:124d52bbebc9d6c43318739080286b049bc9e45bc812000af37edaa6c56f205e
            env:
              <<: *svc-env
              SERVICE_URL: http://rssflow-replace:50051/

      retrieve:
        pod: *node-pod
        containers:
          app:
            <<: *container
            image:
              repository: ghcr.io/m00nwtchr/rssflow-retrieve
              tag: master@sha256:ef119119186e21f35a365668601558e79f4d62221927f5c5f6397a1b54e0216f
            env:
              <<: *svc-env
              SERVICE_URL: http://rssflow-retrieve:50051/

      sanitize:
        pod: *node-pod
        containers:
          app:
            <<: *container
            image:
              repository: ghcr.io/m00nwtchr/rssflow-sanitize
              tag: master@sha256:d97028cae0ec23d6cd87838d71a418122121914f8ea7977867976d01dc9d9934
            env:
              <<: *svc-env
              SERVICE_URL: http://rssflow-sanitize:50051/

    #    rbac:
    #      roles:
    #        rssflow:
    #          type: ClusterRole
    #          rules:
    #            - apiGroups:
    #                - ""
    #              resources:
    #                - services
    #              verbs:
    #                - get
    #                - list
    #                - watch
    #            - apiGroups:
    #                - discovery.k8s.io
    #              resources:
    #                - endpointslices
    #              verbs:
    #                - get
    #                - list
    #                - watch
    #
    #      bindings:
    #        rssflow:
    #          type: ClusterRoleBinding
    #          roleRef:
    #            identifier: rssflow
    #          subjects:
    #            - identifier: rssflow
    #
    #    serviceAccount:
    #      rssflow: { }

    service:
      rssflow:
        controller: rssflow
        ports:
          http:
            port: 80
            targetPort: 3434
          grpc:
            port: *port

      websub:
        controller: websub
        ports:
          http:
            port: 80
            targetPort: 3435
          grpc:
            port: *port

      fetch: &svc
        controller: fetch
        publishNotReadyAddresses: true
        ports:
          grpc:
            port: *port

      filter:
        <<: *svc
        controller: filter

      replace:
        <<: *svc
        controller: replace

      retrieve:
        <<: *svc
        controller: retrieve

      sanitize:
        <<: *svc
        controller: sanitize

    route:
      websub:
        hostnames:
          - "{{ .Release.Name }}.${SECRET_DOMAIN}"
        parentRefs:
          - name: external
            namespace: envoy-gateway-system
            sectionName: https
        rules:
          - matches:
              - path:
                  type: PathPrefix
                  value: /websub/
            backendRefs:
              - identifier: websub
                port: 80
