---
# yaml-language-server: $schema=https://raw.githubusercontent.com/bjw-s-labs/helm-charts/main/charts/other/app-template/schemas/helmrelease-helm-v2.schema.json
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: &app ${APP}
spec:
  interval: 1h
  chartRef:
    kind: OCIRepository
    name: app-template
  install:
    remediation:
      retries: -1
  upgrade:
    cleanupOnFail: true
    remediation:
      retries: 3
  values:
    controllers:
      *app :
        containers:
          app:
            image:
              repository: ghcr.io/m00nwtchr/rssflow
              tag: master@sha256:fcb46a13f5ec5cb8cc0d10efc38dc87556b99f0f9e513b7cf18ab6ab9cc9a3eb
            env:
              RUST_LOG: "info"
              REDIS_URL: redis://dragonfly.database.svc/10
            envFrom:
              - secretRef:
                  name: rssflow-env
            probes: &probes
              liveness: &probe
                enabled: true
                custom: true
                spec:
                  grpc:
                    port: &port 50051
                  #                  service: ""
                  initialDelaySeconds: 5
                  periodSeconds: 10
              readiness: *probe
            resources:
              requests:
                cpu: 50m
                memory: 256Mi

      websub:
        containers:
          app: &container
            image:
              repository: ghcr.io/m00nwtchr/rssflow-websub
              tag: master@sha256:7196280a1e036f2276e8dcfa467955e0719e42acbc5c9492a7fe7176411c63e4
            env: &svc-env
              RUST_LOG: "info"
              REDIS_URL: redis://dragonfly.database.svc/10
            envFrom:
              - secretRef:
                  name: rssflow-websub-env
            probes: *probes
            resources:
              requests:
                cpu: 50m
                memory: 256Mi

      fetch:
        pod: &node-pod
          labels:
            app.kubernetes.io/component: node
        containers:
          app:
            <<: *container
            image:
              repository: ghcr.io/m00nwtchr/rssflow-fetch
              tag: master@sha256:4b928487fc70e2f79c185d8bb0b78f3a7e03510bd81f6d4d8924144025593929
            env:
              <<: *svc-env
              SERVICE_URL: http://rssflow-fetch:50051/

      filter:
        pod: *node-pod
        containers:
          app:
            <<: *container
            image:
              repository: ghcr.io/m00nwtchr/rssflow-filter
              tag: master@sha256:e38f516865140c2f5f0f02b558c6b0426bdea6682786bcef05c95d483fc05e31
            env:
              <<: *svc-env
              SERVICE_URL: http://rssflow-filter:50051/

      replace:
        pod: *node-pod
        containers:
          app:
            <<: *container
            image:
              repository: ghcr.io/m00nwtchr/rssflow-replace
              tag: master@sha256:a406e7c39ce90aeaf5a3f09cdc8035baaaf06ff51225ebb1b4d9060d15e5ebe5
            env:
              <<: *svc-env
              SERVICE_URL: http://rssflow-replace:50051/

      retrieve:
        pod: *node-pod
        containers:
          app:
            <<: *container
            image:
              repository: ghcr.io/m00nwtchr/rssflow-retrieve
              tag: master@sha256:6aa1349412dd415c52eb59be11967654cd106f9a459105320f962cdb7f88b083
            env:
              <<: *svc-env
              SERVICE_URL: http://rssflow-retrieve:50051/

      sanitize:
        pod: *node-pod
        containers:
          app:
            <<: *container
            image:
              repository: ghcr.io/m00nwtchr/rssflow-sanitize
              tag: master@sha256:76a122856aa6d95ca274f8e9c027318ec4b217322803a6c2e6f72dec93e6bce0
            env:
              <<: *svc-env
              SERVICE_URL: http://rssflow-sanitize:50051/

    #    rbac:
    #      roles:
    #        rssflow:
    #          type: ClusterRole
    #          rules:
    #            - apiGroups:
    #                - ""
    #              resources:
    #                - services
    #              verbs:
    #                - get
    #                - list
    #                - watch
    #            - apiGroups:
    #                - discovery.k8s.io
    #              resources:
    #                - endpointslices
    #              verbs:
    #                - get
    #                - list
    #                - watch
    #
    #      bindings:
    #        rssflow:
    #          type: ClusterRoleBinding
    #          roleRef:
    #            identifier: rssflow
    #          subjects:
    #            - identifier: rssflow
    #
    #    serviceAccount:
    #      rssflow: { }

    service:
      rssflow:
        controller: rssflow
        ports:
          http:
            port: 80
            targetPort: 3434
          grpc:
            port: *port

      websub:
        controller: websub
        ports:
          http:
            port: 80
            targetPort: 3435
          grpc:
            port: *port

      fetch: &svc
        controller: fetch
        publishNotReadyAddresses: true
        ports:
          grpc:
            port: *port

      filter:
        <<: *svc
        controller: filter

      replace:
        <<: *svc
        controller: replace

      retrieve:
        <<: *svc
        controller: retrieve

      sanitize:
        <<: *svc
        controller: sanitize

    route:
      websub:
        hostnames:
          - "{{ .Release.Name }}.${SECRET_DOMAIN}"
        parentRefs:
          - name: external
            namespace: envoy-gateway-system
            sectionName: https
        rules:
          - matches:
              - path:
                  type: PathPrefix
                  value: /websub/
            backendRefs:
              - identifier: websub
                port: 80
