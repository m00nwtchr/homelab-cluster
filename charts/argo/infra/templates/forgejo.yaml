apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: forgejo
  namespace: argocd
  finalizers:
    - resources-finalizer.argocd.argoproj.io
  annotations:
    argocd.argoproj.io/sync-wave: "2"
spec:
  project: kubernetes
  source:
    repoURL: code.forgejo.org/forgejo-helm
    chart: forgejo
    targetRevision: 12.5.1
    helm:
      valuesObject:
        ingress:
          enabled: true
          hosts:
            - host: git.{{ .Values.domain }}
              paths:
                - path: /
                  pathType: Prefix

        image:
          rootless: true
          registry: code.forgejo.org
          repository: forgejo/forgejo
          tag: 11.0.1-rootless
          digest: sha256:97b544c9bf4ff13c034a6a8319feffe822ff4f5f73d5bd03dbca3fdeaae0c2ac

        gitea:
          admin:
  {{/*            existingSecret: gitea-admin-secret*/}}
            email: {{ .Values.email }}
          oauth:
            - name: kanidm
              provider: openidConnect
              key: gitea
              existingSecret: "gitea-oidc"
              autoDiscoverUrl: "https://idm.{{ .Values.domain }}/oauth2/openid/gitea/.well-known/openid-configuration"
          config:
            database:
              DB_TYPE: mysql
              HOST: mariadb.mariadb.svc:3306
            server:
              APP_DATA_PATH: /data/gitea
              ROOT_URL: https://git.{{ .Values.domain }}
              START_SSH_SERVER: false
            lfs:
              PATH: /data/git/lfs
            repository:
              ROOT: /data/git/repositories
            indexer:
              ISSUE_INDEXER_TYPE: bleve
              REPO_INDEXER_ENABLED: true
            openid:
              ENABLE_OPENID_SIGNIN: false
              ENABLE_OPENID_SIGNUP: true
              WHITELISTED_URIS: "idm.{{ .Values.domain }}"
            service:
              ALLOW_ONLY_EXTERNAL_REGISTRATION: true
              SHOW_REGISTRATION_BUTTON: false
              ENABLE_PASSWORD_SIGNIN_FORM: false

          additionalConfigFromEnvs:
            - name: GITEA__DATABASE__PASSWD
              valueFrom:
                secretKeyRef:
                  name: gitea-db-user
                  key: mariadb-password

        service:
          ssh:
            clusterIP: 2001:cafe:43::ef37


        redis-cluster:
          enabled: false
        redis:
          enabled: true
        postgresql-ha:
          enabled: false
        postgresql:
          enabled: false

        persistence:
          enabled: true

        extraVolumes:
          - name: git
            persistentVolumeClaim:
              claimName: git
        extraContainerVolumeMounts:
          - name: git
            mountPath: "/data/git/"

  destination:
    name: in-cluster
    namespace: gitea
  syncPolicy:
    automated:
      prune: true
      selfHeal: true
    syncOptions:
      - CreateNamespace=true
