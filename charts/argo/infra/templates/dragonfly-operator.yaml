apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: dragonfly-operator
  namespace: argocd
  annotations:
    argocd.argoproj.io/sync-wave: "0"
  finalizers:
    - resources-finalizer.argocd.argoproj.io
spec:
  project: kubernetes
  source:
    repoURL: ghcr.io/dragonflydb
    chart: dragonfly/helm/dragonfly
    targetRevision: 1.27.2
    helm:
      valuesObject:
        podSecurityContext:
          fsGroup: 2000

        securityContext:
          capabilities:
            drop:
              - ALL
          readOnlyRootFilesystem: true
          runAsNonRoot: true
          runAsUser: 1000

        serviceMonitor:
          enabled: true

        prometheusRule:
          enabled: true
          spec:
            - alert: DragonflyMissing
              expr: absent(dragonfly_uptime_in_seconds) == 1
              for: 0m
              labels:
                severity: critical
              annotations:
                summary: Dragonfly is missing
                description: "Dragonfly is missing"

  destination:
    name: in-cluster
    namespace: dragonfly-operator-system
  syncPolicy:
    automated:
      prune: true
      selfHeal: true
    syncOptions:
      - CreateNamespace=true