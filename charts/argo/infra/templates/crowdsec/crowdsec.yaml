apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: crowdsec
  namespace: argocd
  finalizers:
    - resources-finalizer.argocd.argoproj.io
spec:
  project: kubernetes
  source:
    repoURL: https://crowdsecurity.github.io/helm-charts
    chart: crowdsec
    targetRevision: "0.17"
    helm:
      valuesObject:
        # for raw logs format: json or cri (docker|containerd)
        container_runtime: containerd
        agent:
          # Specify each pod whose logs you want to process
          acquisition:
            # The namespace where the pod is located
            - namespace: traefik
              # The pod name
              podName: traefik-*
              # as in crowdsec configuration, we need to specify the program name to find a matching parser
              program: traefik
          env:
            - name: COLLECTIONS
              value: "crowdsecurity/traefik"

          tolerations:
            - key: untrusted
              operator: Exists
              effect: NoSchedule

        lapi:
          env:
            - name: BOUNCER_KEY_traefik
              valueFrom:
                secretKeyRef:
                  name: traefik-bouncer-key
                  key: secret

        config:
          config.yaml.local: |
            api:
              server:
                auto_registration: # Activate if not using TLS for authentication
                  enabled: false
                  token: "${REGISTRATION_TOKEN}" # /!\ Do not modify this variable (auto-generated and handled by the chart)
                  allowed_ranges: # /!\ Make sure to adapt to the pod IP ranges used by your cluster
                    - "{{ .Values.ipv6ClusterCIDR }}
                    - "{{ .Values.ipv4ClusterCIDR }}"
                tls:
                  bouncers_allowed_ou:
                    - bouncer-ou
                  agents_allowed_ou:
                    - agent-ou

        tls:
          enabled: true
          certManager:
            secretTemplate:
              annotations:
                test.io/test: test

  destination:
    name: in-cluster
    namespace: crowdsec
  syncPolicy:
    automated:
      prune: true
      selfHeal: true
    syncOptions:
      - ServerSideApply=true
      - CreateNamespace=true