apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: open-webui
  namespace: argocd
  finalizers:
    - resources-finalizer.argocd.argoproj.io
spec:
  project: kubernetes
  sources:
    - repoURL: {{ .Values.repoUrl }}
      path: apps/ai/open-webui
      targetRevision: HEAD
    - repoURL: https://helm.openwebui.com/
      chart: open-webui
      targetRevision: "6.1.0"
      helm:
        valuesObject:
          ingress:
            enabled: true
            annotations:
              traefik.ingress.kubernetes.io/router.middlewares: traefik-vpn-only@kubernetescrd,traefik-auth@kubernetescrd
            host: owui.svc.m00nlit.dev
          envFrom:
            - secretRef:
                name: open-webui-secret
          extraEnvVars:
            - name: HOST
              value: "::"
            - name: WEBUI_URL
              value: "https://owui.svc.{{ .Values.domain }}"
            - name: ENABLE_LOGIN_FORM
              value: "false"

            - name: GLOBAL_LOG_LEVEL
              value: "DEBUG"

            - name: DATABASE_URL
              valueFrom:
                secretKeyRef:
                  name: open-webui-secret
                  key: DATABASE_URL

            - name: OAUTH_CLIENT_ID
              value: open-webui
            - name: OAUTH_CLIENT_SECRET
              valueFrom:
                secretKeyRef:
                  name: open-webui-oidc
                  key: secret
            - name: OPENID_PROVIDER_URL
              value: "https://idm.{{.Values.domain}}/oauth2/openid/open-webui/.well-known/openid-configuration"

            - name: ENABLE_OAUTH_SIGNUP
              value: "true"
            - name: ENABLE_OAUTH_ROLE_MANAGEMENT
              value: "true"
            - name: ENABLE_OAUTH_GROUP_MANAGEMENT
              value: "false"
            - name: OAUTH_SCOPES
              value: "openid email profile"

  destination:
    name: in-cluster
    namespace: ai
  syncPolicy:
    automated:
      prune: true
      selfHeal: true
    syncOptions:
      - ServerSideApply=true
      - CreateNamespace=true
