apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: ollama
  namespace: argocd
  finalizers:
    - resources-finalizer.argocd.argoproj.io
spec:
  project: kubernetes
  source:
    repoURL: https://bjw-s.github.io/helm-charts
    chart: app-template
    targetRevision: "3.7.3"
    helm:
      valuesObject:
          # defaultPodOptions:
          #   securityContext:
          #     runAsUser: 2999
          #     runAsGroup: 2999
          #     fsGroup: 2999
          #     fsGroupChangePolicy: "OnRootMismatch"
          #     runAsNonRoot: true
          #     seccompProfile:
          #       type: RuntimeDefault
          controllers:
            ollama:
              containers:
                app:
                  image:
                    repository: ollama/ollama
                    tag: 0.6.2@sha256:74a0929e1e082a09e4fdeef8594b8f4537f661366a04080e600c90ea9f712721
                  env:
                    TZ: "Europe/Warsaw"
                    OLLAMA_HOST: "::"
                    # OLLAMA_ORIGINS: ""
                    # OLLAMA_KEEP_ALIVE: "24h"
                    # OLLAMA_LOAD_TIMEOUT: "600"
                  securityContext:
                    allowPrivilegeEscalation: false
                    readOnlyRootFilesystem: false
                    capabilities: { drop: ["ALL"] }
                  resources:
                    requests:
                      cpu: 200m
                      memory: 2Gi
          service:
            app:
              controller: ollama
              ports:
                http:
                  port: 80
                  targetPort: 11434
          ingress:
            app:
              enabled: true
              annotations:
                traefik.ingress.kubernetes.io/router.middlewares: traefik-vpn-only@kubernetescrd
              hosts:
                - host: &host "ollama.svc.{{ .Values.domain }}"
                  paths:
                    - path: /
                      service:
                        identifier: app
                        port: http
              tls:
                - hosts:
                    - *host
          persistence:
            config:
              size: 1Gi
              accessMode: ReadWriteOnce
              annotations:
                argocd.argoproj.io/sync-options: Delete=false
              globalMounts:
                - path: /root/.ollama

  destination:
    name: in-cluster
    namespace: ai
  syncPolicy:
    automated:
      prune: true
      selfHeal: true
    syncOptions:
      - ServerSideApply=true
      - CreateNamespace=true

