apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: immich
  namespace: argocd
  finalizers:
    - resources-finalizer.argocd.argoproj.io
spec:
  project: kubernetes
  sources:
    - repoURL: {{ .Values.repoUrl }}
      path: apps/media/immich
      targetRevision: HEAD
    - repoURL: https://immich-app.github.io/immich-charts
      chart: immich
      targetRevision: 0.9.0
      helm:
        valuesObject:
          env:
            DB_HOSTNAME: "immich-pgdb-service.media.svc"
            DB_DATABASE_NAME: "immich"
            DB_USERNAME: "immich"
            DB_PASSWORD:
              secretKeyRef:
                name: postgres-immich-superuser
                key: password
            REDIS_HOSTNAME: "immich-redis-master.media.svc"

          immich:
            persistence:
              library:
                existingClaim: photos

          server:
            ingress:
              main:
                enabled: true
                hosts:
                  - host: photos.m00nlit.dev
                    paths:
                      - path: /
                tls:
                  - hosts:
                      - photos.m00nlit.dev

          redis:
            enabled: true
  destination:
    name: in-cluster
    namespace: media
  syncPolicy:
    automated:
      prune: true
      selfHeal: true