apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: immich
  namespace: argocd
  finalizers:
    - resources-finalizer.argocd.argoproj.io
spec:
  project: kubernetes
  sources:
    - repoURL: {{ .Values.repoUrl }}
      path: apps/media/immich
      targetRevision: HEAD
    - repoURL: https://immich-app.github.io/immich-charts
      chart: immich
      targetRevision: 0.9.2
      helm:
        valuesObject:
          image: { }

          env:
            DB_HOSTNAME: "immich-postgres-rw.media.svc"
            DB_DATABASE_NAME: "immich"
            DB_USERNAME: "immich"
            DB_PASSWORD:
              secretKeyRef:
                name: immich-postgres-user
                key: password
            REDIS_HOSTNAME: "immich-redis-master.media.svc"

          immich:
            persistence:
              library:
                existingClaim: photos

          server:
            image:
              repository: ghcr.io/immich-app/immich-server
              tag: v1.131.3@sha256:7e5b6729b12b5e5cc5d98bcc6f7c27f723fabae4ee77696855808ebd5200bbf8
            ingress:
              main:
                enabled: true
                hosts:
                  - host: photos.m00nlit.dev
                    paths:
                      - path: /
                tls:
                  - hosts:
                      - photos.m00nlit.dev

          machine-learning:
            image:
              repository: ghcr.io/immich-app/immich-machine-learning
              tag: v1.131.2@sha256:29836cf73146057ac388546021fff3e00c923e22a28587cceb5108a5e537987d

          redis:
            enabled: true
  destination:
    name: in-cluster
    namespace: media
  syncPolicy:
    automated:
      prune: true
      selfHeal: true
