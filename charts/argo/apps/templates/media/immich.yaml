apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: immich
  namespace: argocd
  finalizers:
    - resources-finalizer.argocd.argoproj.io
spec:
  project: kubernetes
  sources:
    - repoURL: {{ .Values.repoUrl }}
      path: apps/media/immich
      targetRevision: HEAD
    - repoURL: https://immich-app.github.io/immich-charts
      chart: immich
      targetRevision: 0.9.3
      helm:
        valuesObject:
          image: { }

          env:
            DB_HOSTNAME: "immich-postgres-rw.media.svc"
            DB_DATABASE_NAME: "immich"
            DB_USERNAME: "immich"
            DB_PASSWORD:
              secretKeyRef:
                name: immich-postgres-user
                key: password
            REDIS_HOSTNAME: "dragonfly.database.svc"

          immich:
            persistence:
              library:
                existingClaim: photos

          server:
            image:
              repository: ghcr.io/immich-app/immich-server
              tag: v1.134.0@sha256:073fc04c7e3d18ace466c20763809cf17aa55765ed610f12971b392a6a80b50c
            ingress:
              main:
                enabled: true
                annotations:
                  gethomepage.dev/enabled: "true"
                  gethomepage.dev/group: Media
                  gethomepage.dev/name: Immich
                  gethomepage.dev/icon: immich.svg
                hosts:
                  - host: photos.m00nlit.dev
                    paths:
                      - path: /
                tls:
                  - hosts:
                      - photos.m00nlit.dev

          machine-learning:
            image:
              repository: ghcr.io/immich-app/immich-machine-learning
              tag: v1.134.0@sha256:e157e0fa0d4363b0b6bab1923adab5951bbcdb71cd9016470bc6810dae21d115
  destination:
    name: in-cluster
    namespace: media
  syncPolicy:
    automated:
      prune: true
      selfHeal: true
