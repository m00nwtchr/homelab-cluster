apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: immich
  namespace: argocd
  finalizers:
    - resources-finalizer.argocd.argoproj.io
spec:
  project: kubernetes
  sources:
    - repoURL: {{ .Values.repoUrl }}
      path: apps/media/immich
      targetRevision: HEAD
    - repoURL: https://immich-app.github.io/immich-charts
      chart: immich
      targetRevision: 0.9.0
      helm:
        valuesObject:
          image: { }

          env:
            DB_HOSTNAME: "immich-postgres-rw.media.svc"
            DB_DATABASE_NAME: "immich"
            DB_USERNAME: "immich"
            DB_PASSWORD:
              secretKeyRef:
                name: immich-postgres-user
                key: password
            REDIS_HOSTNAME: "immich-redis-master.media.svc"

          immich:
            persistence:
              library:
                existingClaim: photos

          server:
            image:
              repository: ghcr.io/immich-app/immich-server
              tag: v1.129.0@sha256:7122354defac839a7ecf541395907c21805f6a2b60b67ee476e66b162f1a355d
            ingress:
              main:
                enabled: true
                hosts:
                  - host: photos.m00nlit.dev
                    paths:
                      - path: /
                tls:
                  - hosts:
                      - photos.m00nlit.dev

          machine-learning:
            image:
              repository: ghcr.io/immich-app/immich-machine-learning
              tag: v1.127.0@sha256:d38705cdebe2389b46e11d46b7874ffb81d7e7bbf68eaa02df6f26b97d550901

          redis:
            enabled: true
  destination:
    name: in-cluster
    namespace: media
  syncPolicy:
    automated:
      prune: true
      selfHeal: true
