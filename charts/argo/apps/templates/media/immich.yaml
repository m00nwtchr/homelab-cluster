apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: immich
  namespace: argocd
  finalizers:
    - resources-finalizer.argocd.argoproj.io
spec:
  project: kubernetes
  sources:
    - repoURL: {{ .Values.repoUrl }}
      path: apps/media/immich
      targetRevision: HEAD
    - repoURL: https://immich-app.github.io/immich-charts
      chart: immich
      targetRevision: 0.9.0
      helm:
        valuesObject:
          image: { }

          env:
            DB_HOSTNAME: "immich-postgres-rw.media.svc"
            DB_DATABASE_NAME: "immich"
            DB_USERNAME: "immich"
            DB_PASSWORD:
              secretKeyRef:
                name: immich-postgres-user
                key: password
            REDIS_HOSTNAME: "immich-redis-master.media.svc"

          immich:
            persistence:
              library:
                existingClaim: photos

          server:
            image:
              repository: ghcr.io/immich-app/immich-server
              tag: v1.127.0@sha256:6606ce7740f7a06f7a53b49083100c6c05f75c84c85a87e9e4e7309ac0c5d454
            ingress:
              main:
                enabled: true
                hosts:
                  - host: photos.m00nlit.dev
                    paths:
                      - path: /
                tls:
                  - hosts:
                      - photos.m00nlit.dev

          machine-learning:
            image:
              repository: ghcr.io/immich-app/immich-machine-learning
              tag: v1.129.0@sha256:072b5eec074476726c38994ca80edc8d19e14859d49b0f1b6aaa04b0ce415f0c

          redis:
            enabled: true
  destination:
    name: in-cluster
    namespace: media
  syncPolicy:
    automated:
      prune: true
      selfHeal: true
