apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: atm10-server
  namespace: argocd
  finalizers:
    - resources-finalizer.argocd.argoproj.io
spec:
  project: kubernetes
  source:
    repoURL: ghcr.io/itzg
    chart: minecraft-server-charts/minecraft
    targetRevision: 4.26.0
    helm:
      valuesObject:
        minecraftServer:
          serviceType: ClusterIP
{{/*          nodePort: 30100*/}}
          externalTrafficPolicy: Local
          ipFamilyPolicy: PreferDualStack
          externalIPs:
            - 100.116.45.53
            - fd7a:115c:a1e0::f201:2d35

          eula: true
          type: "AUTO_CURSEFORGE"
          autoCurseForge:
            apiKey:
              existingSecret: "curseforge"
            pageUrl: "https://www.curseforge.com/minecraft/modpacks/all-the-mods-10"

          jvmXXOpts: |
            -XX:+UseG1GC
            -XX:+ParallelRefProcEnabled
            -XX:MaxGCPauseMillis=200
            -XX:+UnlockExperimentalVMOptions
            -XX:+DisableExplicitGC
            -XX:+AlwaysPreTouch
            -XX:G1NewSizePercent=30
            -XX:G1MaxNewSizePercent=40
            -XX:G1HeapRegionSize=8M
            -XX:G1ReservePercent=20
            -XX:G1HeapWastePercent=5
            -XX:G1MixedGCCountTarget=4
            -XX:InitiatingHeapOccupancyPercent=15
            -XX:G1MixedGCLiveThresholdPercent=90
            -XX:G1RSetUpdatingPauseTimePercent=5
            -XX:SurvivorRatio=32
            -XX:+PerfDisableSharedMem
            -XX:MaxTenuringThreshold=1
          memory: 8G

        extraEnv:
          ALLOW_FLIGHT: true
          ENABLE_ROLLING_LOGS: true

        livenessProbe:
          enabled: false
        readinessProbe:
          enabled: false

        startupProbe:
          enabled: true
          initialDelaySeconds: 0
          periodSeconds: 10
          timeoutSeconds: 5
          failureThreshold: 43200  # Allows up to 43200 * 5 = 216,000 seconds (60 hours) of retries

        persistence:
          annotations:
            - argocd.argoproj.io/sync-options: Delete=false
          dataDir:
            enabled: true
            Size: 1Gi

        resources:
          requests:
            memory: 8Gi
            cpu: 4
          limits:
            memory: 10Gi

        workloadAsStatefulSet: true
        strategyType: RollingUpdate

  destination:
    name: in-cluster
    namespace: minecraft
  syncPolicy:
    automated:
      prune: true
      selfHeal: true
    syncOptions:
      - CreateNamespace=true