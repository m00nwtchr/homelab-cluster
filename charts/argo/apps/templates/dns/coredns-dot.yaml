apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: coredns-dot
  namespace: argocd
  finalizers:
    - resources-finalizer.argocd.argoproj.io
spec:
  project: kubernetes
  source:
    repoURL: https://coredns.github.io/helm
    chart: coredns
    targetRevision: 1.42.1
    helm:
      valuesObject:
        isClusterService: false
        service:
          name: dot
          externalIPs:
            - 192.168.0.10
            - fe80::9e6b:ff:fe08:bb03
            - 2a02:a313:43e4:7080::7dc5
            - 100.116.45.53
            - fd7a:115c:a1e0::f201:2d35
        serviceType: LoadBalancer

        prometheus:
          service:
            enabled: true
          monitor:
            enabled: true

        servers:
          - port: 53
            zones:
              - zone: m00nlit.dev
                use_tcp: true
                use_udp: true
            plugins:
              - name: errors
              - name: log

              - name: health
                configBlock: |-
                  lameduck 5s
              - name: ready
              - name: prometheus
                parameters: 0.0.0.0:9153

              - name: view
                parameters: local-dns
                configBlock: |-
                  expr incidr(client_ip(), '192.168.0.0/16') || incidr(client_ip(), '2a02:a313:43e4:7080::/57')

              - name: template
                parameters: IN A
                configBlock: |-
                  match .*\.?m00nlit\.dev\.
                  answer "{{`{{ .Name }}`}} 60 IN A 192.168.0.10"
              - name: template
                parameters: IN AAAA
                configBlock: |-
                  match .*\.?m00nlit\.dev\.
                  answer "{{`{{ .Name }}`}} 60 IN AAAA fe80::9e6b:ff:fe08:bb03"

              - name: forward
                parameters: ". tls://2620:fe::fe tls://2620:fe::9 tls://9.9.9.9 tls://149.112.112.112"
                configBlock: |-
                  tls_servername dns.quad9.net
                  health_check 5s
                  max_concurrent 1000
              - name: cache
                parameters: "30"

              - name: reload

          - port: 53
            zones:
              - zone: m00nlit.dev
                use_tcp: true
                use_udp: true
            plugins:
              - name: errors
              - name: log

              - name: health
                configBlock: |-
                  lameduck 5s
              - name: ready
              - name: prometheus
                parameters: 0.0.0.0:9153

              - name: view
                parameters: tailscale-dns
                configBlock: |-
                  expr incidr(client_ip(), '100.64.0.0/10') || incidr(client_ip(), 'fd7a:115c:a1e0::/48')

              - name: template
                parameters: IN A
                configBlock: |-
                  match .*\.?m00nlit\.dev\.
                  answer "{{`{{ .Name }}`}} 60 IN A 100.116.45.53"
              - name: template
                parameters: IN AAAA
                configBlock: |-
                  match .*\.?m00nlit\.dev\.
                  answer "{{`{{ .Name }}`}} 60 IN AAAA fd7a:115c:a1e0::f201:2d35"

              - name: forward
                parameters: ". tls://2620:fe::fe tls://2620:fe::9 tls://9.9.9.9 tls://149.112.112.112"
                configBlock: |-
                  tls_servername dns.quad9.net
                  health_check 5s
                  max_concurrent 1000
              - name: cache
                parameters: "30"

              - name: reload

          - port: 53
            zones:
              - zone: .
                use_tcp: true
                use_udp: true
            plugins:
              - name: errors

              - name: health
                configBlock: |-
                  lameduck 5s
              - name: ready
              - name: prometheus
                parameters: 0.0.0.0:9153

              - name: forward
                parameters: . tls://2620:fe::fe tls://2620:fe::9 tls://9.9.9.9 tls://149.112.112.112
                configBlock: |-
                  tls_servername dns.quad9.net
                  health_check 5s
                  max_concurrent 1000
              - name: cache
                parameters: "30"

              - name: reload
  destination:
    name: in-cluster
    namespace: dns
  syncPolicy:
    automated:
      prune: true
      selfHeal: true