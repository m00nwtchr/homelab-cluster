apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: coredns-dot
  namespace: argocd
  finalizers:
    - resources-finalizer.argocd.argoproj.io
spec:
  project: kubernetes
  source:
    repoURL: https://coredns.github.io/helm
    chart: coredns
    targetRevision: 1.42.1
    helm:
      valuesObject:
        isClusterService: false
        service:
          name: dot

        prometheus:
          service:
            enabled: false
          monitor:
            enabled: false

        servers:
          - port: 53
            zones:
              - zone: m00nlit.dev
                scheme: dns://
                use_tcp: true
                use_udp: true
            plugins:
              - name: errors
              - name: log

              - name: health
                configBlock: |-
                  lameduck 5s
              - name: ready
              - name: prometheus
                parameters: 0.0.0.0:9153

              - name: template
                parameters: IN A
                configBlock: |-
                  match .*\.?m00nlit\.dev\.
                  answer "{{`{{ .Name }}`}} 60 IN A 192.168.0.10"
              - name: template
                parameters: IN AAAA
                configBlock: |-
                  match .*\.?m00nlit\.dev\.
                  answer "{{`{{ .Name }}`}} 60 IN AAAA fe80::9e6b:ff:fe08:bb03"

              - name: forward
                parameters: ". tls://2620:fe::fe tls://2620:fe::9 tls://9.9.9.9 tls://149.112.112.112"
                configBlock: |-
                  tls_servername dns.quad9.net
                  health_check 5s
              - name: cache
                parameters: "30"

              - name: reload
          - port: 53
            zones:
              - zone: .
                scheme: dns://
                use_tcp: true
                use_udp: true
            plugins:
              - name: errors

              - name: health
                configBlock: |-
                  lameduck 5s
              - name: ready
              - name: prometheus
                parameters: 0.0.0.0:9153

              - name: forward
                parameters: . tls://2620:fe::fe tls://2620:fe::9 tls://9.9.9.9 tls://149.112.112.112
                configBlock: |-
                  tls_servername dns.quad9.net
                  health_check 5s
              - name: cache
                parameters: "30"

              - name: reload
  destination:
    name: in-cluster
    namespace: dns
  syncPolicy:
    automated:
      prune: true
      selfHeal: true