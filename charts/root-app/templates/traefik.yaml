apiVersion: v1
kind: Namespace
metadata:
  name: traefik
  labels:
    name: traefik
---
apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: traefik-crds
  namespace: argocd
  annotations:
    argocd.argoproj.io/sync-wave: "1"
  finalizers:
    - resources-finalizer.argocd.argoproj.io
spec:
  project: default
  source:
    repoURL: https://traefik.github.io/charts
    chart: traefik-crds
    targetRevision: 1.2.0
  destination:
    namespace: default
    server: https://kubernetes.default.svc
  syncPolicy:
    automated:
      prune: true
      selfHeal: true
---
apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: traefik
  namespace: argocd
  annotations:
    argocd.argoproj.io/sync-wave: "2"
  finalizers:
    - resources-finalizer.argocd.argoproj.io
spec:
  project: default
  source:
    repoURL: https://traefik.github.io/charts
    chart: traefik
    targetRevision: 34.1.0
    helm:
      skipCrds: true
      valuesObject:
        ingressRoute:
          dashboard:
            enabled: true
            matchRule: Host(`traefik.{{ .Values.domain }}`)
        ports:
          websecure:
            asDefault: true
            http3:
              enabled: true
        tlsStore:
          default:
            defaultCertificate:
              secretName: "wildcard-{{ include "domainDashed" . }}-tls"
        tlsOptions:
          default:
            labels: {}
            sniStrict: true
            minVersion: "VersionTLS13"
          intermediate:
            labels: {}
            sniStrict: true
            minVersion: "VersionTLS12"
            cipherSuites:
              - TLS_ECDHE_ECDSA_WITH_AES_128_GCM_SHA256
              - TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256
              - TLS_ECDHE_ECDSA_WITH_AES_256_GCM_SHA384
              - TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384
              - TLS_ECDHE_ECDSA_WITH_CHACHA20_POLY1305
              - TLS_ECDHE_RSA_WITH_CHACHA20_POLY1305
        globalArguments: []
        metrics:
          prometheus:
            service:
              enabled: true
            disableAPICheck: false
            serviceMonitor:
              enabled: true
              metricRelabelings:
                - sourceLabels: [__name__]
                  separator: ;
                  regex: ^fluentd_output_status_buffer_(oldest|newest)_.+
                  replacement: $1
                  action: drop
              relabelings:
                - sourceLabels: [__meta_kubernetes_pod_node_name]
                  separator: ;
                  regex: ^(.*)$
                  targetLabel: nodename
                  replacement: $1
                  action: replace
              jobLabel: traefik
              interval: 30s
              honorLabels: true
            prometheusRule:
              enabled: true
              rules:
                - alert: TraefikDown
                  expr: up{job="traefik"} == 0
                  for: 5m
                  labels:
                    context: traefik
                    severity: warning
                  annotations:
                    summary: "Traefik Down"
                    description: "{{ $labels.pod }} on {{ $labels.nodename }} is down"
  destination:
    namespace: traefik
    server: https://kubernetes.default.svc
  syncPolicy:
    automated:
      prune: true
      selfHeal: true
