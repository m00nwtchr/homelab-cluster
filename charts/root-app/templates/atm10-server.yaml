apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: atm10-server
  namespace: argocd
  finalizers:
    - resources-finalizer.argocd.argoproj.io
spec:
  project: default
  source:
    repoURL: https://itzg.github.io/minecraft-server-charts/
    chart: minecraft
    targetRevision: 4.23.7
    helm:
      valuesObject:
        minecraftServer:
          serviceType: ClusterIP
          externalIPs:
            - fd7a:115c:a1e0::f201:2d35

          eula: true
          type: "AUTO_CURSEFORGE"
          autoCurseForge:
            apiKey:
              existingSecret: "curseforge"
            pageUrl: "https://www.curseforge.com/minecraft/modpacks/all-the-mods-10"

          jvmOpts: |
            -Djava.net.preferIPv4Stack=false
            -Djava.net.preferIPv6Addresses=true

          jvmXXOpts: |
            -XX:+UseG1GC
            -XX:+ParallelRefProcEnabled
            -XX:MaxGCPauseMillis=200
            -XX:+UnlockExperimentalVMOptions
            -XX:+DisableExplicitGC
            -XX:+AlwaysPreTouch
            -XX:G1NewSizePercent=30
            -XX:G1MaxNewSizePercent=40
            -XX:G1HeapRegionSize=8M
            -XX:G1ReservePercent=20
            -XX:G1HeapWastePercent=5
            -XX:G1MixedGCCountTarget=4
            -XX:InitiatingHeapOccupancyPercent=15
            -XX:G1MixedGCLiveThresholdPercent=90
            -XX:G1RSetUpdatingPauseTimePercent=5
            -XX:SurvivorRatio=32
            -XX:+PerfDisableSharedMem
            -XX:MaxTenuringThreshold=1
          memory: 8G

        extraEnv:
          ALLOW_FLIGHT: true
          ENABLE_ROLLING_LOGS: true
          JAVA_TOOL_OPTIONS: |
            -Djava.net.preferIPv4Stack=false
            -Djava.net.preferIPv6Addresses=true

        startupProbe:
          enabled: true
          initialDelaySeconds: 0
          periodSeconds: 10
          timeoutSeconds: 5
          failureThreshold: 43200  # Allows up to 43200 * 5 = 216,000 seconds (60 hours) of retries

        persistence:
          annotations: { }
          dataDir:
            enabled: true
            Size: 1Gi

        resources:
          requests:
            memory: 8Gi
            cpu: 6
          limits:
            memory: 10Gi
            cpu: 8

        workloadAsStatefulSet: true
        strategyType: RollingUpdate

  destination:
    namespace: minecraft
    server: https://kubernetes.default.svc
  syncPolicy:
    automated:
      prune: true
      selfHeal: true
    syncOptions:
      - CreateNamespace=true