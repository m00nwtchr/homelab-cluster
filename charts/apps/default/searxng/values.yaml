---
# yaml-language-server: $schema=https://raw.githubusercontent.com/bjw-s/helm-charts/app-template-3.2.0/charts/other/app-template/values.schema.json

app-template:
  controllers:
    searxng:
      strategy: RollingUpdate
      containers:
        main:
          image:
            repository: docker.io/searxng/searxng
            tag: 2025.2.26-e86bfa163@sha256:662971a55feacea2eacd2a8a2f51b3e26b56a73080dd131d079d15d7b991faed
            pullPolicy: IfNotPresent

          env:
            SEARXNG_BASE_URL: https://search.svc.m00nlit.dev
            SEARXNG_URL: https://search.svc.m00nlit.dev
            SEARXNG_PORT: &httpPort 8080
            SEARXNG_BIND_ADDRESS: "::"
            SEARXNG_REDIS_URL: redis://dragonfly.database.svc:6379/0
          envFrom:
            - secretRef:
                name: searxng-secret
          probes:
            liveness: &probes
              enabled: false
              custom: true
              spec:
                httpGet:
                  path: /stats
                  port: 8080
                initialDelaySeconds: 0
                periodSeconds: 10
                timeoutSeconds: 1
                failureThreshold: 3
            readiness: *probes
          resources:
            requests:
              cpu: 10m
              memory: 256Mi
          #            limits:
          #              memory: 2Gi
          securityContext:
            allowPrivilegeEscalation: false
            readOnlyRootFilesystem: true
            capabilities:
              drop:
                - ALL
              add:
                - CHOWN
                - SETGID
                - SETUID
                - DAC_OVERRIDE

#    redis:
#      pod:
#        securityContext:
#          runAsUser: 65534
#          runAsGroup: 65534
#      strategy: RollingUpdate
#      containers:
#        redis:
#          image:
#            repository: docker.io/valkey/valkey
#            tag: 8.1.1-alpine@sha256:f43639a6811342b5db26475f3463d4d1950d07bf05542d9483159a44be1fe62f
#          args:
#            - --save
#            - ""
#            - --appendonly
#            - "no"
#          resources:
#            requests:
#              cpu: 5m
#              memory: 32Mi
#            limits:
#              memory: 128Mi
#          securityContext:
#            allowPrivilegeEscalation: false
#            readOnlyRootFilesystem: true
#            capabilities:
#              drop:
#                - ALL

  service:
    app:
      controller: searxng
      ipFamilies: [ IPv4 ]
      ports:
        http:
          port: *httpPort

  ingress:
    app:
      annotations:
        traefik.ingress.kubernetes.io/router.middlewares: traefik-vpn-only@kubernetescrd
      hosts:
        - host: search.svc.m00nlit.dev
          paths:
            - path: /
              service:
                identifier: app
                port: http

  persistence:
    config:
      type: configMap
      name: searxng
      globalMounts:
        - path: /etc/searxng/settings.yml
          subPath: settings.yaml
          readOnly: true
        - path: /etc/searxng/favicons.toml
          subPath: favicons.toml
          readOnly: true
        - path: /etc/searxng/limiter.toml
          subPath: limiter.toml
          readOnly: true
    tmpfs:
      enabled: true
      type: emptyDir
      globalMounts:
        - path: /etc/searxng
    tmpfs2:
      enabled: true
      type: emptyDir
      globalMounts:
        - path: /tmp
