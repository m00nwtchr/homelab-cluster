---
apiVersion: v1
kind: ConfigMap
metadata:
  name: stalwart
data:
  config.toml: |
    [server]
    hostname = "mail.m00nlit.dev"

    [server.listener.smtp]
    bind = "[::]:25"
    protocol = "smtp"

    [server.listener.submission]
    bind = "[::]:587"
    protocol = "smtp"

    [server.listener.submissions]
    bind = "[::]:465"
    protocol = "smtp"
    tls.implicit = true

    [server.listener.imap]
    bind = "[::]:143"
    protocol = "imap"

    [server.listener.imaptls]
    bind = "[::]:993"
    protocol = "imap"
    tls.implicit = true

    [server.listener.pop3]
    bind = "[::]:110"
    protocol = "pop3"

    [server.listener.pop3s]
    bind = "[::]:995"
    protocol = "pop3"
    tls.implicit = true

    [server.listener.sieve]
    bind = "[::]:4190"
    protocol = "managesieve"

    [server.listener.https]
    protocol = "http"
    bind = "[::]:443"
    tls.implicit = true

    [server.listener.http]
    protocol = "http"
    bind = "[::]:8080"

    [storage]
    data = "postgresql"
    fts = "postgresql"
    blob = "filesystem"
    lookup = "redis"
    directory = "kanidm"

    [store.postgresql]
    type = "postgresql"
    host = "postgres-rw.postgres.svc"
    port = 5432
    database = "stalwart"
    user = "{{ "{{ .username }}" }}"
    password = "{{ "{{ .password }}" }}"
    timeout = "15s"

    [store.filesystem]
    type = "fs"
    path = "/var/lib/data/blobs"
    depth = 2

    [store.redis]
    type = "redis"
    redis-type = "single"
    urls = "redis://dragonfly.database.svc"
    timeout = "10s"

    [directory.kanidm]
    type = "ldap"
    url = "ldaps://kanidm-ldaps.kanidm.svc:3636"
    timeout = "30s"

    [directory.oidc]
    type = "oidc"
    timeout = "1s"
    endpoint.url = "https://idm.m00nlit.dev/oauth2/openid/stalwart/userinfo"
    endpoint.method = "userinfo"
    fields.email = "email"
    fields.username = "preferred_username"
    fields.full-name = "name"

    [tracer.log]
    type = "log"
    level = "info"
    path = "/opt/stalwart/logs"
    prefix = "stalwart.log"
    rotate = "daily"
    ansi = false
    enable = false

    [authentication.fallback-admin]
    user = "admin"
    secret = "$6$O0XoAnHBuLdYvKzV$5fesy/IOHf0U043evnn8hz.EQP2X0cD3WIdyS9xF3gMYYMmLwvVO1cBShEFk0GSQSVpcLph/dGOxJt8R/.Woo0"