{ { - $address := printf "http://%s.%s.svc" .Release.Name .Release.Namespace - } }

  { { - $secret := lookup "v1" "Secret" .Release.Namespace (printf "%s-config" .Release.Name) - } }
  { { - $asToken := "" - } }
  { { - $hsToken := "" - } }

  { { - if $secret - } }
  { { - $data := fromYaml (b64dec (index $secret.data "registration.yaml")) - } }
  { { - $asToken := $data.appservice.as_token - } }
  { { - $hsToken := $data.appservice.hs_token - } }
  { { - else - } }
  { { - $asToken := randAlphaNum 64 - } }
  { { - $hsToken := randAlphaNum 64 - } }
  { { - end - } }
apiVersion: v1
kind: Secret
metadata:
  name: { { .Release.Name } }-config
stringData:
  registration.yaml: |
    id: heisenbridge
    url: "{{ $address }}
    as_token: {{ $asToken }}
    hs_token: {{ $hsToken }}
    rate_limited: false
    sender_localpart: heisenbridge
    namespaces:
      users:
        - regex: '@irc_.*'
          exclusive: true
        - regex: '@heisenbridge:.*'
          exclusive: true
      aliases: []
      rooms: []