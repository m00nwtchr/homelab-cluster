app-template:
  controllers:

    rssflow:
      containers:
        app:
          image:
            repository: ghcr.io/m00nwtchr/rssflow
            tag: master@sha256:0a10d424892e4d6a1c23f4950be75db62edee5f2ad565cd26a63d351ad261f7f
          env:
            RUST_LOG: "info"
            REDIS_URL: redis://dragonfly.database.svc
          envFrom:
            - secretRef:
                name: rssflow-env
          probes: &probes
            liveness: &probe
              enabled: true
              custom: true
              spec:
                grpc:
                  port: &port 50051
                #                  service: ""
                initialDelaySeconds: 5
                periodSeconds: 10
            readiness: *probe
          resources:
            requests:
              cpu: 50m
              memory: 256Mi
      serviceAccount:
        identifier: rssflow

    websub:
      containers:
        app: &controller
          image:
            repository: ghcr.io/m00nwtchr/rssflow-websub
            tag: master@sha256:7196280a1e036f2276e8dcfa467955e0719e42acbc5c9492a7fe7176411c63e4
          env: &svc-env
            RUST_LOG: "info"
            REDIS_URL: redis://dragonfly.database.svc
          envFrom:
            - secretRef:
                name: rssflow-websub-env
          probes: *probes
          resources:
            requests:
              cpu: 50m
              memory: 256Mi

    fetch:
      containers:
        app:
          <<: *controller
          image:
            repository: ghcr.io/m00nwtchr/rssflow-fetch
            tag: master@sha256:4b928487fc70e2f79c185d8bb0b78f3a7e03510bd81f6d4d8924144025593929
          env:
            <<: *svc-env
            SERVICE_URL: http://rssflow-fetch:50051/

    filter:
      containers:
        app:
          <<: *controller
          image:
            repository: ghcr.io/m00nwtchr/rssflow-filter
            tag: master@sha256:e38f516865140c2f5f0f02b558c6b0426bdea6682786bcef05c95d483fc05e31
          env:
            <<: *svc-env
            SERVICE_URL: http://rssflow-filter:50051/

    replace:
      containers:
        app:
          <<: *controller
          image:
            repository: ghcr.io/m00nwtchr/rssflow-replace
            tag: master@sha256:a406e7c39ce90aeaf5a3f09cdc8035baaaf06ff51225ebb1b4d9060d15e5ebe5
          env:
            <<: *svc-env
            SERVICE_URL: http://rssflow-replace:50051/

    retrieve:
      containers:
        app:
          <<: *controller
          image:
            repository: ghcr.io/m00nwtchr/rssflow-retrieve
            tag: master@sha256:6aa1349412dd415c52eb59be11967654cd106f9a459105320f962cdb7f88b083
          env:
            <<: *svc-env
            SERVICE_URL: http://rssflow-retrieve:50051/

    sanitize:
      containers:
        app:
          <<: *controller
          image:
            repository: ghcr.io/m00nwtchr/rssflow-sanitize
            tag: master@sha256:76a122856aa6d95ca274f8e9c027318ec4b217322803a6c2e6f72dec93e6bce0
          env:
            <<: *svc-env
            SERVICE_URL: http://rssflow-sanitize:50051/

  rbac:
    roles:
      rssflow:
        type: ClusterRole
        rules:
          - apiGroups:
              - ""
            resources:
              - services
            verbs:
              - get
              - list
              - watch
          - apiGroups:
              - discovery.k8s.io
            resources:
              - endpointslices
            verbs:
              - get
              - list
              - watch

    bindings:
      rssflow:
        type: ClusterRoleBinding
        roleRef:
          identifier: rssflow
        subjects:
          - identifier: rssflow

  serviceAccount:
    rssflow: { }

  service:
    rssflow:
      controller: rssflow
      ports:
        http:
          port: 80
          targetPort: 3434
        grpc:
          port: *port

    websub:
      controller: websub
      ports:
        http:
          port: 80
          targetPort: 3435
        grpc:
          port: *port

    fetch:
      controller: fetch
      ports:
        grpc:
          port: *port

    filter:
      controller: filter
      ports:
        grpc:
          port: *port

    replace:
      controller: replace
      ports:
        grpc:
          port: *port

    retrieve:
      controller: retrieve
      ports:
        grpc:
          port: *port

    sanitize:
      controller: sanitize
      ports:
        grpc:
          port: *port

  ingress:
    websub:
      enabled: true
      hosts:
        - host: "rssflow.m00nlit.dev"
          paths:
            - path: /websub/
              service:
                identifier: websub
                port: http