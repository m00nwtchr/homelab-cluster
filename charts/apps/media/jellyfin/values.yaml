app-template:
  controllers:
    jellyfin:
      annotations:
        reloader.stakater.com/auto: "true"

      pod:
        #        nodeSelector:
        #          intel.feature.node.kubernetes.io/gpu: "true"
        securityContext:
          runAsUser: 2000
          runAsGroup: 2000
          fsGroup: 2000
          fsGroupChangePolicy: "OnRootMismatch"
          supplementalGroups:
            - 44
            - 109
            - 65542 # gladius:external-services

      containers:
        app:
          image:
            repository: ghcr.io/jellyfin/jellyfin
            tag: 10.10.7@sha256:e4d1dc5374344446a3a78e43dd211247f22afba84ea2e5a13cbe1a94e1ff2141
          env:
            DOTNET_SYSTEM_IO_DISABLEFILELOCKING: "true"
            JELLYFIN_PublishedServerUrl:
          probes:
            liveness: &probes
              enabled: true
              custom: true
              spec:
                httpGet:
                  path: /health
                  port: &port 8096
                initialDelaySeconds: 0
                periodSeconds: 10
                timeoutSeconds: 1
                failureThreshold: 3
            readiness: *probes
            startup:
              enabled: false
          resources:
            requests:
              cpu: 100m
              #              gpu.intel.com/i915: 1
              memory: 512Mi
            limits:
              #              gpu.intel.com/i915: 1
              memory: 4Gi

  service:
    app:
      controller: jellyfin
      #      type: LoadBalancer
      annotations:
      #        lbipam.cilium.io/ips: 10.1.1.133
      ports:
        http:
          port: 80
          targetPort: *port

  ingress:
    app:
      annotations:
        gethomepage.dev/enabled: "true"
        gethomepage.dev/group: Media
        gethomepage.dev/name: Jellyfin
        gethomepage.dev/icon: jellyfin.svg
        gethomepage.dev/widget.type: jellyfin
        gethomepage.dev/widget.enableBlocks: "true"
        gethomepage.dev/widget.url: "http://jellyfin.media.svc"
        gethomepage.dev/widget.key: "{{ \"{{HOMEPAGE_VAR_JELLYFIN_KEY}}\" }}"
      hosts:
        - host: jellyfin.m00nlit.dev
          paths:
            - path: /
              service:
                identifier: app
                port: http
        - host: jellyfin.svc.m00nlit.dev
          paths:
            - path: /
              service:
                identifier: app
                port: http

  persistence:
    config:
      size: 1Gi
      accessMode: ReadWriteOnce
      annotations:
        argocd.argoproj.io/sync-options: Delete=falses
      advancedMounts:
        jellyfin:
          app:
            - path: /config
    media:
      existingClaim: media
      globalMounts:
        - path: /mnt/media
    tmpfs:
      type: emptyDir
      advancedMounts:
        jellyfin:
          app:
            - path: /cache
              subPath: cache
            - path: /transcode
              subPath: transcode
            - path: /media
              subPath: screaming