app-template:
  controllers:
    jellyfin:
      #      annotations:
      #        reloader.stakater.com/auto: "true"

      pod:
        #        nodeSelector:
        #          intel.feature.node.kubernetes.io/gpu: "true"
        securityContext:
          runAsUser: 2000
          runAsGroup: 2000
          fsGroup: 2000
          fsGroupChangePolicy: "OnRootMismatch"
          supplementalGroups:
            - 44
            - 109
            - 65542 # gladius:external-services

      containers:
        app:
          image:
            repository: docker.io/jellyfin/jellyfin
            tag: "10.10.5"
          env:
            DOTNET_SYSTEM_IO_DISABLEFILELOCKING: "true"
            JELLYFIN_PublishedServerUrl:
          probes:
            liveness: &probes
              enabled: true
              custom: true
              spec:
                httpGet:
                  path: /health
                  port: &port 8096
                initialDelaySeconds: 0
                periodSeconds: 10
                timeoutSeconds: 1
                failureThreshold: 3
            readiness: *probes
            startup:
              enabled: false
          resources:
            requests:
              cpu: 100m
              #              gpu.intel.com/i915: 1
              memory: 512Mi
            limits:
              #              gpu.intel.com/i915: 1
              memory: 4Gi

  service:
    app:
      controller: jellyfin
      #      type: LoadBalancer
      annotations:
      #        lbipam.cilium.io/ips: 10.1.1.133
      ports:
        http:
          port: 80
          targetPort: *port

  ingress:
    app:
      #      annotations:
      #        external-dns.alpha.kubernetes.io/target: ingress-ext.bjw-s.dev
      #      className: "external-nginx"
      hosts:
        - host: jellyfin.m00nlit.dev
          paths:
            - path: /
              service:
                identifier: app
                port: http

  persistence:
    config:
      size: 1Gi
      accessMode: ReadWriteOnce
      annotations:
        argocd.argoproj.io/sync-options: Delete=falses
      advancedMounts:
        jellyfin:
          app:
            - path: /config
    media:
      existingClaim: media
      globalMounts:
        - path: /mnt/media
        - path: /media
    tmpfs:
      type: emptyDir
      advancedMounts:
        jellyfin:
          app:
            - path: /cache
              subPath: cache
            - path: /transcode
              subPath: transcode