app-template:
  controllers:
    qbittorrent:
      type: statefulset

      #annotations:
      #  secret.reloader.stakater.com/reload: qbittorrent-secret,qbittorrent-gluetun-secret

      pod:
        securityContext:
          fsGroup: 2000
          fsGroupChangePolicy: "OnRootMismatch"
          supplementalGroups:
            - 65542 # gladius:external-services
        terminationGracePeriodSeconds: 120

      #initContainers:
      #dnsdist:
      #  image:
      #    repository: docker.io/powerdns/dnsdist-19
      #    tag: 1.9.8
      #  restartPolicy: Always

      #gluetun:
      #  dependsOn:
      #    - dnsdist
      #  image:
      #    repository: ghcr.io/qdm12/gluetun
      #    tag: v3.40.0
      #  env:
      #    DOT: "off"
      #    DNS_ADDRESS: "127.0.0.2"
      #    HTTP_CONTROL_SERVER_AUTH_CONFIG_FILEPATH: &gluetunAuthPath /gluetun/auth.toml
      #    VPN_SERVICE_PROVIDER: custom
      #    VPN_TYPE: wireguard
      #    VPN_INTERFACE: wg0
      #    WIREGUARD_ENDPOINT_PORT: 51820
      #    VPN_PORT_FORWARDING: on
      #    VPN_PORT_FORWARDING_PROVIDER: protonvpn
      #    FIREWALL_INPUT_PORTS: 8080
      #    FIREWALL_OUTBOUND_SUBNETS: 10.96.0.0/12,10.244.0.0/16 # Allow access to k8s subnets
      #  envFrom:
      #    - secretRef:
      #        name: qbittorrent-secret
      #  lifecycle:
      #    postStart:
      #      exec:
      #        command: [ "/bin/sh", "-c", "(ip rule del table 51820; ip -6 rule del table 51820) || true" ]
      #  resources:
      #   limits:
      #      squat.ai/tun: "1"
      #  restartPolicy: Always
      #  securityContext:
      #    capabilities:
      #      add:
      #        - NET_ADMIN
      #    allowPrivilegeEscalation: false

      containers:
        app:
          nameOverride: qbittorrent
          image:
            repository: ghcr.io/home-operations/qbittorrent
            tag: 5.0.4@sha256:995c561247b069c10b1fa098186f35b3155c2df63912041f70637a9232755756
          env:
            UMASK: "022"
            QBT_WEBUI_PORT: &port 8080
            #XSEED_HOST: cross-seed.downloads.svc.cluster.local
            #XSEED_PORT: 2468
            #XSEED_APIKEY:
            #  valueFrom:
            #    secretKeyRef:
            #      name: qbittorrent-secret
            #      key: xseed_api_key
          probes:
            liveness:
              enabled: true
            readiness:
              enabled: true
            startup:
              enabled: true
              spec:
                failureThreshold: 30
                periodSeconds: 5
          resources:
            requests:
              cpu: 150m
              memory: 2048Mi
            #limits:
            #  memory: 8192Mi
          securityContext:
            runAsUser: 2000
            runAsGroup: 2000
            runAsNonRoot: true
            allowPrivilegeEscalation: false
            readOnlyRootFilesystem: true
            capabilities:
              drop:
                - ALL

        #port-forward:
        #  image:
        #    repository: ghcr.io/bjw-s-labs/gluetun-qb-port-sync
        #    tag: 0.0.4@sha256:1689650236d3f0b9fc79551ce47770e9a743ed3b1d8196f6cc3737cd8cbe92e2
        #  env:
        #    GLUETUN_CONTROL_SERVER_HOST: localhost
        #    GLUETUN_CONTROL_SERVER_PORT: 8000
        #    GLUETUN_CONTROL_SERVER_API_KEY:
        #      valueFrom:
        #        secretKeyRef:
        #          name: qbittorrent-secret
        #          key: GLUETUN_CONTROL_SERVER_API_KEY
        #    QBITTORRENT_HOST: localhost
        #    QBITTORRENT_WEBUI_PORT: *port
        #    CRON_ENABLED: true
        #    CRON_SCHEDULE: "*/5 * * * *"
        #    LOG_TIMESTAMP: false
        #  securityContext:
        #    runAsUser: 2000
        #    runAsGroup: 2000
        #    runAsNonRoot: true
        #    allowPrivilegeEscalation: false
        #    readOnlyRootFilesystem: true
        #    capabilities:
        #      drop:
        #        - ALL

  service:
    app:
      controller: qbittorrent
      nameOverride: ""
      ipFamilyPolicy: PreferDualStack
      primary: true
      ports:
        http:
          targetPort: *port
          port: 80
    torrent:
      controller: qbittorrent
      type: NodePort
      primary: false
      ports:
        torrent-tcp:
          port: 31495
          nodePort: 31495
          protocol: TCP
        torrent-udp:
          port: 31495
          nodePort: 31495
          protocol: UDP

  ingress:
    app:
      annotations:
        traefik.ingress.kubernetes.io/router.middlewares: traefik-vpn-only@kubernetescrd,traefik-auth@kubernetescrd
      hosts:
        - host: qbit.svc.m00nlit.dev
          paths:
            - path: /
              service:
                identifier: app
                port: http

  persistence:
    config:
      size: 1Gi
      accessMode: ReadWriteOnce
      annotations:
        argocd.argoproj.io/sync-options: Delete=false
      advancedMounts:
        qbittorrent:
          app:
            - path: /config
    media:
      existingClaim: media
      advancedMounts:
        qbittorrent:
          app:
            - path: /mnt/media
    #empty-config:
    #  type: emptyDir
    #  advancedMounts:
    #    qbittorrent:
    #      port-forward:
    #        - path: /config
    #gluetun-auth:
    #  type: secret
    #  name: qbittorrent-gluetun-secret
    #  advancedMounts:
    #    qbittorrent:
    #      gluetun:
    #        - path: *gluetunAuthPath
    #          subPath: auth.toml
    #dnsdist:
    #  type: configMap
    #  name: qbittorrent-dnsdist
    #  advancedMounts:
    #    qbittorrent:
    #      dnsdist:
    #        - path: /etc/dnsdist/dnsdist.conf
    #          subPath: dnsdist.conf
    #          readOnly: true
    #scripts:
    #  type: configMap
    #  name: qbittorrent-scripts
    #  defaultMode: 0775
    #  advancedMounts:
    #    qbittorrent:
    #      app:
    #        - path: /config/scripts
